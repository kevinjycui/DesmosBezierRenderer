<script src='https://www.desmos.com/api/v1.6/calculator.js?apiKey=dcb31709b452b1cf9dc26972add0fda6'></script>
<html lang='en'>
   <head>
      <title>Desmos | Graphing Calculator</title>
      <link rel='icon' href='https://www.desmos.com/favicon.ico'>
   </head>
   <div id='calculator' style='width: 100%; height: 100%;'></div>
   <script>
        var elt = document.getElementById('calculator');
        var calculator = Desmos.GraphingCalculator(elt);

        var inner = elt.getElementsByClassName('dcg-graph-outer')[0]; // The part of the screen with a visible grid
        var defaultState;
        var hiddenGraph;
        var latex;
        var height;
        var width;
        var download_images;
        var total_frames;

        function sleep(milliseconds) {
            return new Promise(r => setTimeout(r, milliseconds));
        }

        async function changeGraph(latex) {
            //console.log(latex);

            var default_expressions = hiddenGraph.expressions.list.slice();

            for (var expr of latex) {
                hiddenGraph.expressions.list.push({
                    color: expr.color,
                    id: expr.id,
                    latex: expr.latex,
                    type: "expression"
                })
            }

            calculator.setState( hiddenGraph, {'allowUndo': false} );
            hiddenGraph.expressions.list = default_expressions;
            await sleep(5000);
        }

        xhr = new XMLHttpRequest();
        const interval = setInterval(() => { // Attempt backend connection
            xhr.open('GET', `http://127.0.0.1:5000/init`);
            xhr.send();
        }, 1000);

        xhr.onload = () => { // Setup when backend connects successfully
            clearInterval(interval);
            latex = JSON.parse(xhr.response);
            height = latex.height;
            width = latex.width;
            total_frames = latex.total_frames;
            download_images = latex.download_images;

            var lastFrame = parseInt(sessionStorage.getItem('lastFrame')) || 0; // Get frame from page refresh
            sessionStorage.removeItem('lastFrame');

            calculator.updateSettings({
                showGrid: latex.show_grid,
                showXAxis: latex.show_grid,
                showYAxis: latex.show_grid
            });

            calculator.setMathBounds({
                left: 0,
                right: width,
                bottom: 0,
                top: height
            });

            calculator.setExpression({ id: 'frame', latex: `f=${lastFrame}`, color: '#2464b4', sliderBounds: { step: 1, max: total_frames, min: 0 } });
            calculator.setExpression({ id: 'lines', latex: 'l=0', color: '#2464b4' });

            // This is used to set expressions off screen
            hiddenGraph = calculator.getState();
            
            if (lastFrame != 0) { // This is a refresh
                const viewport = JSON.parse(sessionStorage.getItem('viewport'));
                sessionStorage.removeItem('viewport');
                calculator.setViewport([viewport.xmin, viewport.xmax, viewport.ymin, viewport.ymax]);
                renderFrame(lastFrame);
            } else { // This is the first time loading the page
                var f = calculator.HelperExpression({ latex: 'f' });
                f.observe('numericValue', () => {
                    if (Number.isNaN(f.numericValue) || f.numericValue <= 0) return;
                    f.unobserve('numericValue');
                    setTimeout(() => renderFrame(--f.numericValue), 3000); // Wait for additional keystrokes
                });
            }
            defaultState = calculator.getState(); // setBlank resets graph settings, this doesn't
            defaultState.graph.showGrid = defaultState.graph.showXAxis = defaultState.graph.showYAxis = latex.show_grid;
        }

        async function renderFrame(frame) {
            
            const requestData = (frame) => {
            
                return new Promise((resolve, reject) => {

                    xhr = new XMLHttpRequest();
                    xhr.open('GET', `http://127.0.0.1:5000/?frame=${frame}`);
                    xhr.send();
                    xhr.onload = () => {
                        latex = JSON.parse(xhr.response);

                        if (latex.result === null){
                            reject(`frame: ${frame} could not be rendered.`);
                        } else {
                            resolve(latex.result);
                        }
                    }
                });
            }

            try { // Render each frame
                var response = await requestData(frame);
                while (response) {
                    hiddenGraph.expressions.list[0].latex = "f=" + (frame + 1);
                    hiddenGraph.expressions.list[1].latex = "l=" + response.length;

                    // console.log('Lines for frame ' + (frame + 1) + ': ' + response.length);

                    await changeGraph(response);

                    const params = {
                        mode: 'stretch',
                        mathBounds: { left: 0, bottom: 0, right: width, top: height },
                        width: width,
                        height: height,
                        targetPixelRatio: 1
                    }
                    
                    frame++;
                    calculator.asyncScreenshot(params, screenshot => handleScreenshot(screenshot, frame)); // Waits for frame to render, takes a screenshot and runs handleScreenshot
                    response = await requestData(frame);
                }
            }
            catch (err) {
                console.log(err);
            }
        }

        const imgcont = document.createElement('a');
        document.body.appendChild(imgcont);
        async function handleScreenshot(screenshot, frame) {
            imgcont.href = screenshot;
            imgcont.download = 'frame-' + String(frame).padStart(5, '0');
            imgcont.innerHTML = `<img src= ${screenshot}>`;
            if (download_images) imgcont.click();

            // Reloading the page every so often seems to reduce random slowdowns
            if (frame % 20 === 0) { // run every 20 frames
                sessionStorage.setItem('lastFrame', frame +1);
                sessionStorage.setItem('viewport', JSON.stringify(calculator.getState().graph.viewport));
                location.reload();
            }
        }
   </script>
</html>
